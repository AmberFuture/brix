class BrixAccessesSettings{constructor(e={}){this.step=e.step??1,this.tagSelectorData=e.tagSelectorData,this.accessInfo=e.accessInfo;let t=!(!e.isChange||"Y"!==e.isChange),s=!(!e.common||"Y"!==e.common),i=e.iblockId??0,o=e.iblockIdMany?e.iblockIdMany.split(","):[];switch(this.isChange=()=>t,this.getCommon=()=>s,this.getIblockId=()=>Number(i),this.getIblockIdMany=()=>o,this.step){case 2:this.twoStep();break;case 3:this.threeStep()}}twoStep(){BX.Runtime.loadExtension("ui.entity-selector").then(e=>{this.createTagselector(e.TagSelector)}),this.isChange()&&this.formSubmit()}threeStep(){this.formSubmit(),this.accessInit(),this.isChange()&&(this.createModal(),BX.Runtime.loadExtension("ui.progressbar").then(e=>{this.createProgress(e.ProgressBar)}))}createTagselector(o){this.tagSelectorList={},this.multiRights=new Map,this.rightsMode=!1,this.selectedIblock=0;let a=this,c;if(0<Object.keys(this.tagSelectorData).length)for(var r in this.tagSelectorData){let e=this.tagSelectorData[r],t=e.settings,s=document.getElementById(""+e.container),i=document.getElementById(""+r);s&&(s.addEventListener("keyup",e=>this.eventKeyup(e)),t.dialogOptions.events={"Item:onSelect":e=>{e=e.getData().item;e.getDialog().isMultiple()?a.multipleValue(i,e.getId()):(i.value=e.getId(),a.rightsMode=e.getCustomData().get("rights"),a.changeLockTagSelector(!1))},"Item:onDeselect":e=>{e=e.getData().item;e.getDialog().isMultiple()?a.multipleValue(i,e.getId(),"remove"):(i.value="",a.rightsMode=!1,a.changeLockTagSelector())}},this.getCommon()&&t.multiple&&(t.dialogOptions.events.onLoad=e=>{e=e.getTarget().getItems();0<e.length&&(e.forEach(e=>{var t=e.getCustomData();0<t.size&&a.multiRights.set(e.getId(),t.get("rights"))}),a.checkSelectedMultiTagSelector(e))}),c=new o(t),(this.tagSelectorList[r]=c).renderTo(s),this.tagSelectorList[r].getDialog().getTabs().forEach(e=>{e.setVisible(!1)}))}this.changeLockTagSelector()}changeLockTagSelector(e=!0){var t;this.getCommon()&&0===this.getIblockId()&&(t=Object.keys(this.tagSelectorList).pop(),e?this.tagSelectorList[t].lock():(this.checkSelectedMultiTagSelector(),this.tagSelectorList[t].unlock()))}checkSelectedMultiTagSelector(r=[]){if(this.getCommon()){let e=Object.keys(this.tagSelectorList),t=e.shift(),s=e.pop(),i=this.tagSelectorList[t].getDialog(),o=this.tagSelectorList[s].getDialog(),a=i.getSelectedItems()[0].getId(),c=0<r.length?r:o.getItems();0<c.length&&c.forEach(e=>{var t=e.getId();this.multiRights.get(t)&&(this.multiRights.get(t)!==this.rightsMode||Number(t)===Number(a)?(e.setHidden(!0),e.isSelected()&&e.deselect()):e.setHidden(!1))})}}multipleValue(e,t,s="add"){var i;e&&t&&(i=e.value,"add"===s?e.value=""===i?t:i+","+t:"remove"===s&&""!==i&&-1!==(i=(s=i.split(",")).indexOf(t))&&(s.splice(i,1),e.value=s.join(",")))}eventKeyup(e){"Enter"!==e.key&&13!==e.keyCode||e.target.querySelector(".ui-tag-selector-add-button-caption").click()}accessInit(){if(this.access={},0<Object.keys(this.accessInfo).length&&this.accessInfo.IBLOCKS&&0<Object.keys(this.accessInfo.IBLOCKS).length){var e,t=this.accessInfo.RIGHTS_LIST.EXTENDED,s=this.accessInfo.RIGHTS_LIST.NO_EXTENDED,i=this.accessInfo.RIGHTS_NAME,o=this.isChange()?"Y":"N";for(e in this.accessInfo.IBLOCKS){var a=this.accessInfo.IBLOCKS[e],c="Y"===a.EXTENDED?t:s;this.access[e]=new BrixAccess({wrap:"ib_"+e,isAccess:o,isExtended:""+a.EXTENDED,options:c,names:i,items:a.ACCESS})}}}createModal(){new BrixModal({data:{classModal:"brix-settings__modal",text:'<div class="brix-settings__modal-progress"></div>',buttons:[`<button class="brix-settings__modal-stop ui-btn ui-btn-primary-dark">${BX.message("BRIX_ACCESSES_SETTINGS_TEMPLATE_JS_STOP")}</button>`],btnCenter:!0},showInParent:!1,maxWidth:400,modalOpen:!1,escapeEvents:!1})}createProgress(e){this.stopBtn=document.querySelector(".brix-settings__modal-stop"),this.iblockCount=this.getIblockIdMany().length,this.stop=!1,0!==this.getIblockId()&&this.iblockCount++,this.progress=new e({size:e.Size.LARGE,maxValue:this.iblockCount,value:0,statusType:e.Status.PERCENT,textAfter:BX.message("BRIX_ACCESSES_SETTINGS_TEMPLATE_JS_PROGRESS"),column:!0}),this.progress.renderTo(document.querySelector(".brix-settings__modal-progress")),this.stopBtn.addEventListener("click",()=>{this.stop=!0,this.progress.setTextAfter(BX.message("BRIX_ACCESSES_SETTINGS_TEMPLATE_JS_STOP_PROGRESS")),this.stopBtn.disabled=!0})}formSubmit(){document.getElementById("accesses-settings-form").addEventListener("submit",t=>{if("accesses-settings-back"===t.submitter.id)this.step--,document.querySelector('[name="STEP"]').value=this.step;else if(2===Number(this.step)){let e=!1;for(var s in this.tagSelectorList)0===this.tagSelectorList[s].getDialog().getSelectedItems().length&&(e=!0,s=document.getElementById(""+this.tagSelectorData[s].container),this.error(s));var i;e&&(t.preventDefault(),i=document.querySelector(".accesses-settings__alert"))&&i.classList.remove("d-none")}else if(3===Number(this.step)&&!this.stop){t.preventDefault();let s={};for(var e in this.access)s[e]={},s[e].ITEMS=this.access[e].items,s[e].EXTENDED=document.querySelector(`[name="EXTENDED_${e}"]`).checked?"Y":"N";if(0!==this.getIblockId()){let t=this.getIblockId();this.getIblockIdMany().forEach(e=>{s[Number(e)]=s[t]})}document.querySelector("dialog").show(),this.saveAccess(s)}})}saveAccess(t){let s=this,e=Object.keys(t),i=e[0],o=t[i].EXTENDED,a=t[i].ITEMS,c=this.iblockCount-e.length+1;delete t[i],this.stop?this.stopProgress(BX.message("BRIX_ACCESSES_SETTINGS_TEMPLATE_JS_STOP_FINISH")):BX.ajax.runAction("brix:accesses.iblock.saveAccess",{data:{iblockId:i,extended:o,arAccess:a}}).then(e=>{s.progress.update(c),s.progress.isFinish()?s.stopProgress(BX.message("BRIX_ACCESSES_SETTINGS_TEMPLATE_JS_FINISH")):s.saveAccess(t)},e=>{console.error(e),alert("An error has occurred")})}stopProgress(e=""){this.stop=!0,this.stopBtn.disabled=!0,this.progress.setTextAfter(e),this.progress.finish(),setTimeout(()=>{document.getElementById("accesses-settings-form").submit()},3e3)}error(e){e&&e.classList.add("error")}}