function BrixLinkedDetail(e={}){let t=document.getElementById("conditions").content,i=document.getElementById("additional").content;this._fieldName=e.fieldName??"",this.countRules=0,this._items=[],this._select=[],this._tagSelectors=[],this.getFields=()=>e.allFields??{},this.getFieldsMandatory=()=>e.fieldsMandatory??{},this.getConditions=()=>e.conditions??{},this.getTemplate=()=>t,this.getTemplateAdditional=()=>i,this._fieldName?(this.rulesField(this._fieldName),this.showRules(),this.currentConditions(e.currentConditions)):(this.createSelect("FIELD_NAME",e.listField,BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_FIELD_NAME_PLACEHOLDER")),this.deleteLoader()),this.add(),this.events()}BrixLinkedDetail.prototype={deleteLoader(){document.querySelector(".brix-loader").remove()},showRules(){document.getElementById("all-rules").classList.remove("d-none")},currentConditions(e){0<e.length&&(e.forEach(e=>{var t;"object"==typeof e?(t="object"==typeof e.value?JSON.stringify(e.value):e.value,this.newConditions(this.countRules,e.field,e.type,t),this.countRules++):"string"==typeof e&&this.newAdditionl(this.countRules,e)}),setTimeout(()=>{Object.keys(this._tagSelectors).forEach(e=>{e.includes("VALUES")&&this.selectedTagSelector(e)})},1e3)),this.deleteLoader()},createSelect(t,e,i,a=!0,l="",s="",n=""){""===l&&0<e.length&&(e[0].check?l=e[0].value:e[1]&&e[1].check&&(l=e[1].value));let r=new BX.Ui.Select({value:l,options:e,isSearchable:a,placeholder:i,popupParams:{maxHeight:300}});this._select[t]=r,document.querySelector(`[name="${t}"]`)&&(this.updateSelect(t,l,s,n),r.subscribe("update",e=>{this.updateSelect(t,r.getValue())})),r.renderTo(document.querySelector(`[data-name="${t}"]`))},updateSelect(e,t="",i="",a=""){var l=document.querySelector(`[name="${e}"]`);""!==t&&("FIELD_NAME"===e?(""===this._fieldName&&this.showRules(),this._fieldName=t,this.checkMandatory(this._fieldName),this.rulesField(this._fieldName)):e.includes("CONDITIONS")&&(e.includes("FIELD")?l.value!==t&&this.rulesConditions(e,t,i,a):e.includes("TYPE")&&l.value!==t&&this.newValues(e,t))),this.changeInput(l,t)},changeInput(e,t="",i=!1){e.value=i?0<t.length?JSON.stringify(t):"":t},checkMandatory(e){var t=this.getFieldsMandatory();""===e||"N"===t[e]?document.getElementById("linked-detail-mandatory").classList.add("d-none"):document.getElementById("linked-detail-mandatory").classList.remove("d-none")},rulesField(i){var e=this.getFields();this._items=[],Object.entries(e).forEach(([e,t])=>{e!==i&&this._items.push({value:e,label:t.LABEL})}),Object.entries(this._select).forEach(([e,t])=>{e.includes("CONDITIONS")&&e.includes("FIELD")&&t.getValue()===i&&(t.hideMenu(),delete this._select[e],this.createSelect(e,this._items,BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_FIELD_NAME_PLACEHOLDER")),t=e.replace("FIELD","TYPE"),this._select[t])&&(delete this._select[t],document.querySelector(`[data-name="${t}"] .ui-select`).remove())})},rulesConditions(e,a,t="",i=""){let l=this.getConditions(),s=this.getFields(),n=[],r=s[a].USER_TYPE_ID,c=s[a].MULTIPLE,o=[],u=BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_TYPE_PLACEHOLDER");var d;e=e.replace("FIELD","TYPE"),Object.entries(l).forEach(([e,t])=>{let i=!1;(i=t.FIELDS.includes(r)&&t.MULTIPLE.includes(c)||t.FIELDS.includes(r)&&"boolean"===r?"CREATED_BY"!==a&&"RESPONSIBLE_ID"!==a||"FILL"!==e:i)&&(n.push({value:e,label:t.NAME}),o.push(e))}),this._select[e]&&(""!==(d=this._select[e].getValue())&&(t=o.includes(d)?d:""),delete this._select[e]),this.createSelect(e,n,u,!0,t),""!==t?this.newValues(e,t,i):this.newValues(e)},add(){var e=document.getElementById("linked-detail-add");e&&e.addEventListener("click",()=>{this.newConditions(this.countRules),this.countRules++})},newConditions(i=0,e="",t="",a=""){var l=document.querySelector(".linked-detail__rules"),s=this.getTemplate().cloneNode(!0),n=s.querySelectorAll("input[name]"),r=n[0].getAttribute("name").replace("#ID#",i);n.forEach(e=>{var t=e.getAttribute("name").replace("#ID#",i);e.setAttribute("name",t),e.nextElementSibling&&e.nextElementSibling.setAttribute("data-name",t)}),s.querySelector(".linked-detail__cond-del").addEventListener("click",e=>{e=e.target.closest(".linked-detail__cond");e.nextElementSibling?e.nextElementSibling.remove():e.previousElementSibling&&e.previousElementSibling.remove(),e.remove()}),0<l.querySelectorAll(".linked-detail__cond").length&&""===e&&this.newAdditionl(i),l.append(s),this.createSelect(r,this._items,BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_FIELD_NAME_PLACEHOLDER"),!0,e,t,a)},newAdditionl(e=0,t=""){e--;var i=document.querySelector(".linked-detail__rules"),a=this.getTemplateAdditional().cloneNode(!0),e=a.querySelector("input[name]").getAttribute("name").replace("#ID#",e),l=BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_ADDITIONAL");""===t&&(t=l[0].value),a.querySelector("input").setAttribute("name",e),a.querySelector("[data-name]").setAttribute("data-name",e),i.append(a),this.createSelect(e,l,BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_FIELD_NAME_PLACEHOLDER"),!1,t)},newValues(e,t="FILL",i=""){var a=e.replace("TYPE","VALUES"),e=e.replace("TYPE","FIELD"),l=this._select[e].getValue(),s=this.getFields();switch(document.querySelector(`[name="${a}"]`).value="",this._tagSelectors[a]&&delete this._tagSelectors[a],document.querySelector(`[data-name="${a}"] .linked-detail__cond-block`)&&document.querySelector(`[data-name="${a}"] .linked-detail__cond-block`).remove(),document.querySelector(`[data-name="${a}"] .ui-select`)&&document.querySelector(`[data-name="${a}"] .ui-select`).remove(),t){case"FILL":this.changeInput(document.querySelector(`[name="${a}"]`)),this._select[t]&&delete this._select[t];break;case"DATE":case"BIG":case"BIG_OR":case"LESS":case"LESS_OR":case"RANGE":var n="DATE"===t?0:s[l].SETTINGS.PRECISION,r="RANGE"===t,c={min:"DATE"===t?1:Number(s[l].SETTINGS.MIN_VALUE),max:"DATE"===t?0:Number(s[l].SETTINGS.MAX_VALUE),step:"DATE"===t||0===s[l].SETTINGS.PRECISION?1:Number("0."+"0".repeat(s[l].SETTINGS.PRECISION-1)+"1")};this.createNumber(a,c,Number(n),r,i);break;case"IN":case"IN_NO":"string"!==s[l].USER_TYPE_ID&&(i=""!==i?JSON.parse(i):[]),"string"===s[l].USER_TYPE_ID?this.createText(a,i):"employee"===s[l].USER_TYPE_ID?this.createTagSelector(a,this.userDialogOptions(i)):"group"===s[l].USER_TYPE_ID?this.createTagSelector(a,this.groupDialogOptions(i)):"enumeration"===s[l].USER_TYPE_ID?(c="brix_userfield_"+s[l].ID,this.createTagSelector(a,this.enumsDialogOptions(Number(s[l].ID),i),c)):"iblock_section"===s[l].USER_TYPE_ID||"iblock_element"===s[l].USER_TYPE_ID?(n=Number(s[l].SETTINGS.IBLOCK_ID),r=s[l].USER_TYPE_ID.replace("iblock_",""),context="brix_userfield_"+n,this.createTagSelector(a,this.iblockDialogOptions(n,r,i),context)):"crm"===s[l].USER_TYPE_ID&&(c="brix_userfield_"+s[l].USER_TYPE_ID,this.createTagSelector(a,this.crmDialogOptions(s[l].SETTINGS,i),c));break;case"KEEP":case"KEEP_NO":case"SAME":case"SAME_NO":let e="SAME_NO"===t?"AND":"OR";"boolean"!==s[l].USER_TYPE_ID&&"string"!==s[l].USER_TYPE_ID&&(i=""!==i?JSON.parse(i):[]),"boolean"===s[l].USER_TYPE_ID?(n=[{value:"0",label:""!==s[l].SETTINGS.LABEL[0]?s[l].SETTINGS.LABEL[0]:BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_NO"),check:""!==i&&0===Number(i)},{value:"1",label:""!==s[l].SETTINGS.LABEL[1]?s[l].SETTINGS.LABEL[1]:BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_YES"),check:""!==i&&1===Number(i)}],this.createSelect(a,n,BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_VALUES",!1,i))):"string"===s[l].USER_TYPE_ID?(e="KEEP_NO"===t?"AND":e,this.createText(a,i,!0,e)):"employee"===s[l].USER_TYPE_ID?this.createTagSelector(a,this.userDialogOptions(i,t),"",!0,e):"tags"===s[l].USER_TYPE_ID?this.createTagSelector(a,this.tagsDialogOptions(i),"",!0,e):"enumeration"===s[l].USER_TYPE_ID?(r="brix_userfield_"+s[l].ID,this.createTagSelector(a,this.enumsDialogOptions(Number(s[l].ID),i),r,!0,e)):"iblock_section"===s[l].USER_TYPE_ID||"iblock_element"===s[l].USER_TYPE_ID?(c=Number(s[l].SETTINGS.IBLOCK_ID),n=s[l].USER_TYPE_ID.replace("iblock_",""),context="brix_userfield_"+c,this.createTagSelector(a,this.iblockDialogOptions(c,n,i),context,!0,e)):"crm"===s[l].USER_TYPE_ID&&(r="brix_userfield_"+s[l].USER_TYPE_ID,this.createTagSelector(a,this.crmDialogOptions(s[l].SETTINGS,i),r,!0,e))}},createNumber(i,a={min:0,max:0,step:0},l=0,s=!1,e=""){let t=this.createContainer(i),n=document.createElement("input"),r=s?document.createElement("input"):"",c,o=[];var u,d;n.classList.add("ui-ctl-element"),n.setAttribute("type","number"),r&&(r.classList.add("ui-ctl-element"),r.setAttribute("type","number")),Object.entries(a).forEach(([e,t])=>{0!==Number(t)&&(n.setAttribute(e,t),r)&&r.setAttribute(e,t)}),s?(u=document.createElement("div"),d=t.querySelector("button")?"":document.createElement("button"),u.classList.add("linked-detail__cond-double"),""!==d&&(d.setAttribute("type","button"),d.classList.add("ui-btn","ui-btn-link"),d.textContent=BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_COND_ADD"),d.addEventListener("click",()=>{this.createNumber(i,a,Number(l),s)}),t.append(d)),""!==e&&((c=(e=JSON.parse(e)).shift()).min&&(n.value=c.min,n.setAttribute("data-value",e)),c.max)&&(r.value=c.max,r.setAttribute("data-value",e)),o.push(n),o.push(r),u.append(n),u.append(r),t.querySelector("button").before(u)):(n.value=e,n.setAttribute("data-value",e),o.push(n),t.append(n)),o.forEach(t=>{["input","paste"].forEach(e=>{t.addEventListener(e,()=>{this.validationNumber(i,t,Number(a.min),Number(a.max),Number(l),s)})}),t.addEventListener("keyup",function(e){"+"!==e.key&&"Equal"!==e.code||(t.value=t.getAttribute("data-value")??"")})}),"object"==typeof e&&0<e.length?this.createNumber(i,a,Number(l),s,JSON.stringify(e)):this.validationNumber(i,n,Number(a.min),Number(a.max),Number(l),s)},validationNumber(t,a,e=0,i=0,l=0,s=!1){var n=a.value;if(""!==n){if(!Number.isInteger(n)){let e=n.toString(),t=e.includes(".")?e.indexOf("."):0,i=e.length-t-1;Number(l)<Number(i)&&(l=Number(l)-Number(i),e=e.slice(0,l),a.value=Number(e))}0!==Number(e)&&Number(n)<Number(e)?a.value=e:0!==Number(i)&&Number(n)>Number(i)&&(a.value=i),a.setAttribute("data-value",n)}if(s){let e=document.querySelectorAll(`[data-name="${t}"] input`),i={},a=[];e.forEach((e,t)=>{t%2==0?i.min=e.value:(i.max=e.value,a.push(i),i={})}),this.changeInput(document.querySelector(`[name="${t}"]`),a,!0)}else this.changeInput(document.querySelector(`[name="${t}"]`),a.value)},createText(i,e="",a=!1,t=""){let l=this.createContainer(i),s=document.createElement("input"),n,r=[];var c,o,u;s.classList.add("ui-ctl-element"),s.setAttribute("type","text"),a?(c=document.createElement("div"),o=l.querySelector("button")?"":document.createElement("button"),u=BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_ADDITIONAL"),u=("OR"===t?u[1]:u[0]).label,c.classList.add("linked-detail__cond-text"),c.setAttribute("data-before",u),""!==o&&(o.setAttribute("type","button"),o.classList.add("ui-btn","ui-btn-link"),o.textContent=BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_COND_ADD"),o.addEventListener("click",()=>{this.createText(i,"",a,t)}),l.append(o)),""!==e&&(n=(e=JSON.parse(e)).shift(),s.value=n),r.push(s),c.append(s),l.querySelector("button").before(c)):(s.value=e,r.push(s),l.append(s)),r.forEach(t=>{["input","paste"].forEach(e=>{t.addEventListener(e,()=>{this.validationText(i,s,a)})})}),"object"==typeof e&&0<e.length?this.createText(i,JSON.stringify(e),a,t):this.validationText(i,s,a)},validationText(i,e,t=!1){var a=e.value;if(""!==a&&a!==a.replace(/(<([^>]+)>)/gi,"")&&(e.value=a.replace(/(<([^>]+)>)/gi,"")),t){let e=document.querySelectorAll(`[data-name="${i}"] input`),t=[];e.forEach(e=>{""!==e.value&&t.push(e.value)}),this.changeInput(document.querySelector(`[name="${i}"]`),t,!0)}else this.changeInput(document.querySelector(`[name="${i}"]`),e.value)},createTagSelector(t,e={},i="",a=!1,l=""){""===i&&(i="brix.linked.detail"),e.context=i,e.enableSearch=!0;let s=this,n=this.createContainer(t),r=[],c={multiple:!0,dialogOptions:e,events:{onAfterTagAdd:e=>{s.selectedTagSelector(t)},onAfterTagRemove:e=>{s.selectedTagSelector(t)}}};e.preselectedItems&&(r=e.preselectedItems,c.dialogOptions.preselectedItems=r.shift());var o,u,d,E=new BX.UI.EntitySelector.TagSelector(c);this._tagSelectors[t]||(this._tagSelectors[t]=[]),this._tagSelectors[t].push(E),a?(o=document.createElement("div"),u=n.querySelector("button")?"":document.createElement("button"),d=BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_ADDITIONAL"),d=("OR"===l?d[1]:d[0]).label,o.classList.add("linked-detail__cond-tagselector"),o.setAttribute("data-before",d),""!==u&&(u.setAttribute("type","button"),u.classList.add("ui-btn","ui-btn-link"),u.textContent=BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_COND_ADD"),e.preselectedItems&&delete e.preselectedItems,u.addEventListener("click",()=>{this.createTagSelector(t,e,i,a,l)}),n.append(u)),n.querySelector("button").before(o),E.renderTo(o)):E.renderTo(n),0<r.length&&(e.preselectedItems=r,this.createTagSelector(t,e,i,a,l))},userDialogOptions(e=[],t=""){let i={entities:[{id:"user",options:{inviteEmployeeLink:!1}},{id:"department",options:{selectMode:"usersOnly"}}]};return(""===t||"SAME"!==t&&"SAME_NO"!==t)&&(i.entities[1].options={selectMode:"usersAndDepartments",allowFlatDepartments:!0}),0<e.length&&(i.preselectedItems=[],e.forEach(e=>{let a=[];e.forEach(e=>{var t="U"===e.charAt(0),i=!t&&"C"===e.charAt(1),i=t?Number(e.slice(1)):i?Number(e.slice(2)):e.slice(1)+":F";a.push([t?"user":"department",i])}),i.preselectedItems.push(a)})),i},groupDialogOptions(e=[]){let i={entities:[{id:"project",options:{createProjectLink:!1}}]};return 0<e.length&&(i.preselectedItems=[],e.forEach(e=>{let t=[];e.forEach(e=>{t.push(["project",e])}),i.preselectedItems.push(t)})),i},tagsDialogOptions(e=[]){let i={entities:[{id:"brix_task_tag",dynamicLoad:!0,dynamicSearch:!0}]};return 0<e.length&&(i.preselectedItems=[],e.forEach(e=>{let t=[];e.forEach(e=>{t.push(["brix_task_tag",e])}),i.preselectedItems.push(t)})),i},enumsDialogOptions(e,t=[]){let i={entities:[{id:"brix_enumeration",options:{id:e}}]};return 0<t.length&&(i.preselectedItems=[],t.forEach(e=>{let t=[];e.forEach(e=>{t.push(["brix_enumeration",e])}),i.preselectedItems.push(t)})),i},iblockDialogOptions(e,i="element",t=[]){let a={entities:[{id:i="iblock-property-"+i,dynamicLoad:!0,dynamicSearch:!0,options:{iblockId:e}}]};return 0<t.length&&(a.preselectedItems=[],t.forEach(e=>{let t=[];e.forEach(e=>{t.push([i,e])}),a.preselectedItems.push(t)})),a},crmDialogOptions(e,t=[]){let i=[],a={entities:[]},l={CO:"company",C:"contact",D:"deal",L:"lead",Q:"quote",SI:"smart_invoice"},s=[];return Object.entries(e).forEach(([e,t])=>{"Y"===t&&(e.includes("DYNAMIC_")?(t=e.split("_",2),l["DYN"+t[1]]="dynamic_multiple",s.push(Number(t[1]))):i.push({id:e.toLowerCase(),dynamicLoad:!0,dynamicSearch:!0}))}),0<s.length&&i.push({id:"dynamic_multiple",dynamicLoad:!0,dynamicSearch:!0,options:{dynamicTypeIds:s}}),a.entities=i,0<t.length&&(a.preselectedItems=[],t.forEach(e=>{let t=[];e.forEach(e=>{e=e.split("_",2);"DYN"===e[0]?t.push(["dynamic_multiple",e[1]]):t.push([l[e[0]],Number(e[1])])}),a.preselectedItems.push(t)})),a},selectedTagSelector(e){let a=[],l=0,s={company:"CO_",contact:"C_",deal:"D_",lead:"L_",quote:"Q_",smart_invoice:"SI_"};this._tagSelectors[e].forEach(e=>{e=e.getDialog().getSelectedItems();0<e.length&&(a[l]=[],e.forEach(e=>{var t,i=e.getEntityId(),e=e.getId();"user"===i?a[l].push("U"+e):"department"===i?"number"==typeof e?a[l].push("DC"+e):(t=e.split(":"),a[l].push("D"+Number(t[0]))):s[i]?a[l].push(""+s[i]+e):"dynamic_multiple"===i?a[l].push("DYN_"+e):a[l].push(e)}),l++)}),this.changeInput(document.querySelector(`[name="${e}"]`),a,!0)},createContainer(e){let t=document.querySelector(`[data-name="${e}"] .linked-detail__cond-block`);return t||((t=document.createElement("div")).classList.add("linked-detail__cond-block"),document.querySelector(`[data-name="${e}"]`).append(t)),t},events(){let E=this,m=this.getFields();document.getElementById("linked-detail-close").addEventListener("click",()=>{var e=BX.SidePanel.Instance.getTopSlider();e&&e.close()}),document.getElementById("linked-detail-form").addEventListener("submit",e=>{e.preventDefault();let t=new FormData(e.target),i={},a=[],l=[],s=[],n,r,c,o;for(var[u,d]of t)if("FIELD_NAME"===u){if(""===d){s.push(u);break}i[u]=d}else if("ACTIVE"===u||"REQUIRED"===u)i[u]=d;else if(u.includes("CONDITIONS")&&u.includes("FIELD")){if(""===d){s.push(u);break}if(n=u.replace("FIELD","TYPE"),c=u.replace("FIELD","VALUES"),r=document.querySelector(`[name="${n}"]`),o=document.querySelector(`[name="${c}"]`),""===r.value){s.push(n);break}if("FILL"!==r.value&&""===o.value){s.push(c);break}{let e=o.value;("KEEP"===r.value||"KEEP_NO"===r.value||"RANGE"===r.value||"IN"===r.value&&"string"!==m[d].USER_TYPE_ID||"IN_NO"===r.value&&"string"!==m[d].USER_TYPE_ID||"SAME"===r.value&&"boolean"!==m[d].USER_TYPE_ID||"SAME_NO"===r.value&&"boolean"!==m[d].USER_TYPE_ID)&&(e=JSON.parse(o.value)),a.push({field:d,type:r.value,value:e})}}else u.includes("ADDITIONAL")&&l.push(d);i.ACTIVE||(i.ACTIVE="N"),i.REQUIRED||(i.REQUIRED="N"),0===a.length?E.showError():0<s.length?E.showError(!1):(i.CONDITIONS=[],a.forEach((e,t)=>{i.CONDITIONS.push(e),l[t]&&i.CONDITIONS.push(l[t])}),BX.ajax.runAction("brix:linkedtaskfields.linked.update",{data:{fields:i,fieldName:E._fieldName}}).then(e=>{BX.SidePanel.Instance.postMessage(window,"linked-reload");var t=BX.SidePanel.Instance.getTopSlider();t&&t.close()},e=>{console.error(e),e.error?alert(e.error):alert("An error has occurred")}))})},showError(e=!0){var t=document.getElementById("linked-detail-error"),e=e?BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_ERROR_1"):BX.message("BRIX_LINKEDTASKFIELDS_LINKED_DETAIL_TEMPLATE_ERROR_2");t.querySelector(".linked-detail__text").textContent=e,t.classList.remove("d-none");let i=window.pageYOffset+t.getBoundingClientRect().top,a=window.pageYOffset+t.getBoundingClientRect().bottom,l=window.pageYOffset,s=window.pageYOffset+document.documentElement.clientHeight;(a<=l||i>=s)&&t.scrollIntoView({behavior:"smooth",block:"start"})}};