class BrixLinkedTaskEdit{constructor(){var e=void 0!==window.brixTaskParams?window.brixTaskParams:document.querySelector('[name="HIT_STATE[INITIAL_TASK_DATA][GROUP_ID]"]')?{GROUP_ID:document.querySelector('[name="HIT_STATE[INITIAL_TASK_DATA][GROUP_ID]"]').value}:{},e={id:document.querySelector('[name="ACTION[0][ARGUMENTS][id]"]')?document.querySelector('[name="ACTION[0][ARGUMENTS][id]"]').value:0,taskData:e};BX.ajax.runAction("brix:linkedtaskfields.task.get",{data:e}).then(e=>{this.dataCheck(e.data)},e=>{console.error(e)})}dataCheck(t={}){if(t.CONDITIONS&&0<Object.keys(t.CONDITIONS).length&&(this.getConditions=()=>t.CONDITIONS,this.getRelationship=()=>t.RELATIONSHIP??{},this.getFields=()=>t.FIELDS??{},t.HIDE_FIELD&&0<t.HIDE_FIELD.length&&t.HIDE_FIELD.forEach(e=>{this.actionField(e,Number(t.CONDITIONS[e].FIELD_ID))}),this.proxy=new Proxy(t.CURRENT_VALUES,this.handler()),t.FIELDS)&&0<Object.keys(t.FIELDS).length){this._inputChange=!1;let l=[],s={},i=[];Object.entries(t.FIELDS).forEach(([c,r])=>{if(t.DEFAULT_FIELDS.includes(c))this.customEvent(c);else{let e=r.USER_TYPE_ID,t="",a;switch(e){case"boolean":"RADIO"===(t=r.SETTINGS.DISPLAY)?this.checkRadio(c):"DROPDOWN"===t?this.checkSelectSingle(c):"CHECKBOX"===t&&this.checkCheckbox(c,!0);break;case"crm":l.push(c);break;case"date":case"datetime":case"double":case"integer":case"string":this.checkInputText(c,r.MULTIPLE,Number(r.ID));break;case"employee":this.checkEmployee(c,r.MULTIPLE);break;case"enumeration":case"iblock_element":case"iblock_section":t=r.SETTINGS.DISPLAY,a="Y"===r.MULTIPLE,"LIST"===t?a?this.checkSelectMultiple(c):this.checkSelectSingle(c):"CHECKBOX"===t?a?this.checkCheckbox(c):this.checkRadio(c):"UI"===t?this.checkUI(c,a):"DIALOG"===t&&(s[r.ID]=c,i.push("js-id-item-set-item-"+r.ID))}}}),0<l.length&&this.checkCrm(l),0<Object.keys(s).length&&this.checkDialog(s,i)}}actionField(e,t,a=!0){let c=document.querySelector(".js-id-item-set-item-"+t);(c="UF_CRM_TASK"===e?document.querySelector('[data-block-name="UF_CRM_TASK"]'):c)&&(c.style.display=a?"none":"block")}handler(){let c=this;return{get:(e,t)=>t in e?e[t]:null,set:(e,t,a=null)=>{e[t]=a;a=c.getRelationship();return a[t]&&a[t].forEach(t=>{let a=c.getConditions();a[t]&&BX.ajax.runAction("brix:linkedtaskfields.task.checkConditions",{data:{arConditions:a[t].CONDITIONS,arCurrentValues:e,arFields:c.getFields()}}).then(e=>{c.actionField(t,Number(a[t].FIELD_ID),!e.data)},e=>{console.error(e)})}),!0}}}customEvent(t){let a=this,e=BX.UI.EntitySelector.Dialog;switch(t){case"CREATED_BY":case"RESPONSIBLE_ID":var c="CREATED_BY"===t?"tasksMemberSelector_originator":"tasksMemberSelector_responsible";e.getById(c)&&e.getById(c).subscribe("Item:onSelect",e=>{e=e.getTarget().getSelectedItems()[0].getId();a.proxy[t]="U"+e});break;case"DEADLINE":BX.addCustomEvent(window,"change-deadline",e=>{a.proxy[t]=""!==e?e:null});break;case"GROUP_ID":e.getById("tasksMemberSelector_project")&&e.getById("tasksMemberSelector_project").subscribe("Item:onSelect",e=>{a.proxy[t]=e.getTarget().getSelectedItems()[0].getId()}).subscribe("Item:onDeselect",e=>{a.proxy[t]=null});break;case"TAGS":e.getById("tasksTagSelector")&&e.getById("tasksTagSelector").subscribe("Item:onSelect",e=>{a.proxy[t]=a.selectedIds(e.getTarget().getSelectedItems())}).subscribe("Item:onDeselect",e=>{a.proxy[t]=a.selectedIds(e.getTarget().getSelectedItems())})}}selectedIds(e=[]){let t=[];return 0<e.length&&e.forEach(e=>{e=e.getId();"number"==typeof e?t.push(e):t.push("0")}),t}checkRadio(t){var e=document.querySelectorAll(`[name="ACTION[0][ARGUMENTS][data][${t}]"]`);0<e.length&&e.forEach(e=>{e.addEventListener("change",e=>{this.proxy[t]=""!==e.target.value?e.target.value:null})})}checkSelectSingle(t){var e=document.querySelector(`select[name="ACTION[0][ARGUMENTS][data][${t}]"]`);e&&e.addEventListener("change",e=>{this.proxy[t]=""!==e.target.value?e.target.value:null})}checkSelectMultiple(a){let c=document.querySelector(`select[name="ACTION[0][ARGUMENTS][data][${a}][]"]`);c&&c.addEventListener("change",()=>{var e,t=[];for(e of c.options)e.selected&&""!==e.value&&t.push(e.value);this.proxy[a]=0<t.length?t:null})}checkCheckbox(a,t=!1){let e=t?`ACTION[0][ARGUMENTS][data][${a}]`:`ACTION[0][ARGUMENTS][data][${a}][]`,c=document.querySelectorAll(`[type="checkbox"][name="${e}"]`);0<c.length&&c.forEach(e=>{e.addEventListener("click",()=>{if(t)this.proxy[a]=e.checked?1:0;else{let t=[];c.forEach(e=>{e.checked&&""!==e.value&&t.push(e.value)}),this.proxy[a]=0<t.length?t:null}})})}checkCrm(a){let c=this,r={},t=this.getFields();BX.UI.TileSelector&&BX.UI.TileSelector.getList().forEach(e=>{var t=e.getSearchInput().getAttribute("id");for(let e=0;e<a.length;e++)if(t.includes(`[${a[e]}]`)){r[t]=a[e];break}}),["tile-add","tile-remove"].forEach(e=>{BX.Event.EventEmitter.subscribe(e,e=>{var e=e.getTarget(),a=e.getSearchInput().getAttribute("id");if(r.hasOwnProperty(a)){a=r[a],e=e.getTiles();if(0<e.length)if("N"===t[a].MULTIPLE)c.proxy[a]=e[0].id;else{let t=[];e.forEach(e=>{t.push(e.id)}),c.proxy[a]=t}else c.proxy[a]=null}})})}checkInputText(t,a,e){let c=this;var r;"N"===a?(r=document.querySelector(`[name="ACTION[0][ARGUMENTS][data][${t}]"]`))&&c.changeInput(r,a):(0<(r=document.querySelectorAll(`[name="ACTION[0][ARGUMENTS][data][${t}][]"]`)).length&&r.forEach(e=>{c.changeInput(e,t,a)}),(r=document.querySelector(`.js-id-item-set-item-${e} .field-wrap`))&&new MutationObserver(e=>{e.forEach(e=>{0<e.addedNodes.length&&c.changeInput(e.addedNodes[0],t,a)})}).observe(r,{childList:!0}))}changeInput(t,a,c){let r=this;t&&["change","paste","cut","input"].forEach(e=>{t.addEventListener(e,e=>{clearInterval(r._inputChange),r._inputChange=setTimeout(()=>{if("N"===c)r.proxy[a]=e.target.value;else{let t=[],e=document.querySelectorAll(`[name="ACTION[0][ARGUMENTS][data][${a}][]"]`);0<e.length&&e.forEach(e=>{""!==e.value&&t.push(e.value)}),r.proxy[a]=0<t.length?t:null}},800)})})}checkEmployee(t,e){var a=document.querySelector(`[name="ACTION[0][ARGUMENTS][data][${t}]"]`);a&&"N"===e&&a.addEventListener("change",e=>{this.proxy[t]=""!==e.target.value?"U"+e.target.value:null})}checkUI(c,r){let l=this,e=r?`ACTION[0][ARGUMENTS][data][${c}][]`:`ACTION[0][ARGUMENTS][data][${c}]`,t=document.querySelector(`[data-name="${e}"]`);e&&new MutationObserver(e=>{e.forEach(e=>{let t=JSON.parse(e.target.getAttribute("data-value")),a=[];r?(0<t.length&&t.forEach(e=>{""!==e.VALUE&&a.push(e.VALUE)}),l.proxy[c]=0<a.length?a:null):0<Object.keys(t).length&&""!==t.VALUE&&(l.proxy[c]=t.VALUE)})}).observe(t,{attributes:!0,attributeFilter:["data-value"]})}checkDialog(c,r){let l=this,s={},i=this.getFields();BX.UI.EntitySelector&&BX.UI.EntitySelector.Dialog&&(BX.UI.EntitySelector.Dialog.getInstances().forEach(e=>{var t=e.getTargetNode();if(t){t=t.closest(".js-id-item-set-item");if(t)for(var a of t.classList)if(r.includes(a)){a=a.replace("js-id-item-set-item-","");s[c[Number(a)]]=e;break}}}),0<Object.keys(s).length)&&Object.entries(s).forEach(([a,t])=>{["Item:onSelect","Item:onDeselect"].forEach(e=>{t.subscribe(e,e=>{e=e.getTarget().getSelectedItems();if(0<e.length)if("N"===i[a].MULTIPLE)l.proxy[a]=e[0].getId();else{let t=[];e.forEach(e=>{t.push(e.getId())}),l.proxy[a]=t}else l.proxy[a]=null})})})}}document.addEventListener("DOMContentLoaded",()=>{new BrixLinkedTaskEdit});